<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0;minimum-scale=1.0, maximum-scale=1.0;user-scalable=no;">
    <title></title>
    <link rel="stylesheet" href="../layer/css/layui.mobile.css" media="all">
    <link rel="stylesheet" href="../layer/css/modules/layim/mobile/layim.css?v=2.10" media="all">

</head>
<style>
    .vue-dpn
    {
        display: none;
    }
</style>
<body>

<div id="app" class="vue-dpn">
<div id="layui-m-layer1" class="layui-m-layer layui-m-layer1" index="1">
    <div class="layui-m-layermain">
        <div class="layui-m-layersection"><div class="layui-m-layerchild  layui-m-anim--1"><div class="layui-m-layercont"><div class="layim-panel layui-m-anim-left">
<!--            <div class="layim-title" style="background-color: #36373C;"><p><i class="layui-icon layim-chat-back" layim-event="back"></i>薛凌霄<span class="layim-chat-status"></span></p></div>-->
            <div class="layui-unselect layim-content"><div class="layim-chat layim-chat-friend">
                <div class="layim-chat-main" ref="chatMain">
                    <ul>

    <li v-for="(item,index) in list" class="layim-chat-li" v-bind:class="{'layim-chat-mine':(item.user_id == current_user_id)}">
        <div class="layim-chat-user">
            <img :src="current_user_avatar" v-if="item.user_id == current_user_id">
            <img :src="user_avatar" v-else>
        </div>
        <div class="layim-chat-text">{{item.content}}</div>
    </li>


    </ul>
                </div>

        <div class="layim-chat-footer"><div class="layim-chat-send"><input type="text" autocomplete="off" v-model="send_content"><button class="layim-send" v-bind:class="{'layui-disabled':!send_content}" @click="sendMsg">发送</button></div>
            <div class="layim-chat-tool" data-json="%7B%22username%22%3A%22%E8%96%9B%E5%87%8C%E9%9C%84%22%2C%22avatar%22%3A%22https%3A%2F%2Fhuajialife.com%2Fimages%2Fheader2.jpg%22%2C%22id%22%3A2%2C%22type%22%3A%22friend%22%2C%22content%22%3A%221%E7%82%B9%E5%87%86%E5%A4%87%E7%9D%A1%E4%BA%86%22%2C%22mine%22%3Afalse%2C%22timestamp%22%3A1565023914%2C%22name%22%3A%22%E8%96%9B%E5%87%8C%E9%9C%84%22%2C%22historyTime%22%3A1565023914087%2C%22sign%22%3A%221%E7%82%B9%E5%87%86%E5%A4%87%E7%9D%A1%E4%BA%86%22%7D"><span class="layui-icon layim-tool-face" title="选择表情" layim-event="face" style="display: none;"></span>
            </div>
        </div></div></div></div></div></div></div></div>
</div>

    <div id="layui-m-layer6" class="layui-m-layer layui-m-layer1" index="6" style="display: none;"><div class="layui-m-layermain"><div class="layui-m-layersection"><div class="layui-m-layerchild layim-layer layui-m-anim-scale"><div class="layui-m-layercont"><ul class="layui-layim-face"><li title="[微笑]"><img src="http://localhost:63342/webim/layer/images/face/0.gif"></li><li title="[嘻嘻]"><img src="http://localhost:63342/webim/layer/images/face/1.gif"></li><li title="[哈哈]"><img src="http://localhost:63342/webim/layer/images/face/2.gif"></li><li title="[可爱]"><img src="http://localhost:63342/webim/layer/images/face/3.gif"></li><li title="[可怜]"><img src="http://localhost:63342/webim/layer/images/face/4.gif"></li><li title="[挖鼻]"><img src="http://localhost:63342/webim/layer/images/face/5.gif"></li><li title="[吃惊]"><img src="http://localhost:63342/webim/layer/images/face/6.gif"></li><li title="[害羞]"><img src="http://localhost:63342/webim/layer/images/face/7.gif"></li><li title="[挤眼]"><img src="http://localhost:63342/webim/layer/images/face/8.gif"></li><li title="[闭嘴]"><img src="http://localhost:63342/webim/layer/images/face/9.gif"></li><li title="[鄙视]"><img src="http://localhost:63342/webim/layer/images/face/10.gif"></li><li title="[爱你]"><img src="http://localhost:63342/webim/layer/images/face/11.gif"></li><li title="[泪]"><img src="http://localhost:63342/webim/layer/images/face/12.gif"></li><li title="[偷笑]"><img src="http://localhost:63342/webim/layer/images/face/13.gif"></li><li title="[亲亲]"><img src="http://localhost:63342/webim/layer/images/face/14.gif"></li><li title="[生病]"><img src="http://localhost:63342/webim/layer/images/face/15.gif"></li><li title="[太开心]"><img src="http://localhost:63342/webim/layer/images/face/16.gif"></li><li title="[白眼]"><img src="http://localhost:63342/webim/layer/images/face/17.gif"></li><li title="[右哼哼]"><img src="http://localhost:63342/webim/layer/images/face/18.gif"></li><li title="[左哼哼]"><img src="http://localhost:63342/webim/layer/images/face/19.gif"></li><li title="[嘘]"><img src="http://localhost:63342/webim/layer/images/face/20.gif"></li><li title="[衰]"><img src="http://localhost:63342/webim/layer/images/face/21.gif"></li><li title="[委屈]"><img src="http://localhost:63342/webim/layer/images/face/22.gif"></li><li title="[吐]"><img src="http://localhost:63342/webim/layer/images/face/23.gif"></li><li title="[哈欠]"><img src="http://localhost:63342/webim/layer/images/face/24.gif"></li><li title="[抱抱]"><img src="http://localhost:63342/webim/layer/images/face/25.gif"></li><li title="[怒]"><img src="http://localhost:63342/webim/layer/images/face/26.gif"></li><li title="[疑问]"><img src="http://localhost:63342/webim/layer/images/face/27.gif"></li><li title="[馋嘴]"><img src="http://localhost:63342/webim/layer/images/face/28.gif"></li><li title="[拜拜]"><img src="http://localhost:63342/webim/layer/images/face/29.gif"></li><li title="[思考]"><img src="http://localhost:63342/webim/layer/images/face/30.gif"></li><li title="[汗]"><img src="http://localhost:63342/webim/layer/images/face/31.gif"></li><li title="[困]"><img src="http://localhost:63342/webim/layer/images/face/32.gif"></li><li title="[睡]"><img src="http://localhost:63342/webim/layer/images/face/33.gif"></li><li title="[钱]"><img src="http://localhost:63342/webim/layer/images/face/34.gif"></li><li title="[失望]"><img src="http://localhost:63342/webim/layer/images/face/35.gif"></li><li title="[酷]"><img src="http://localhost:63342/webim/layer/images/face/36.gif"></li><li title="[色]"><img src="http://localhost:63342/webim/layer/images/face/37.gif"></li><li title="[哼]"><img src="http://localhost:63342/webim/layer/images/face/38.gif"></li><li title="[鼓掌]"><img src="http://localhost:63342/webim/layer/images/face/39.gif"></li><li title="[晕]"><img src="http://localhost:63342/webim/layer/images/face/40.gif"></li><li title="[悲伤]"><img src="http://localhost:63342/webim/layer/images/face/41.gif"></li><li title="[抓狂]"><img src="http://localhost:63342/webim/layer/images/face/42.gif"></li><li title="[黑线]"><img src="http://localhost:63342/webim/layer/images/face/43.gif"></li><li title="[阴险]"><img src="http://localhost:63342/webim/layer/images/face/44.gif"></li><li title="[怒骂]"><img src="http://localhost:63342/webim/layer/images/face/45.gif"></li><li title="[互粉]"><img src="http://localhost:63342/webim/layer/images/face/46.gif"></li><li title="[心]"><img src="http://localhost:63342/webim/layer/images/face/47.gif"></li><li title="[伤心]"><img src="http://localhost:63342/webim/layer/images/face/48.gif"></li><li title="[猪头]"><img src="http://localhost:63342/webim/layer/images/face/49.gif"></li><li title="[熊猫]"><img src="http://localhost:63342/webim/layer/images/face/50.gif"></li><li title="[兔子]"><img src="http://localhost:63342/webim/layer/images/face/51.gif"></li><li title="[ok]"><img src="http://localhost:63342/webim/layer/images/face/52.gif"></li><li title="[耶]"><img src="http://localhost:63342/webim/layer/images/face/53.gif"></li><li title="[good]"><img src="http://localhost:63342/webim/layer/images/face/54.gif"></li><li title="[NO]"><img src="http://localhost:63342/webim/layer/images/face/55.gif"></li><li title="[赞]"><img src="http://localhost:63342/webim/layer/images/face/56.gif"></li><li title="[来]"><img src="http://localhost:63342/webim/layer/images/face/57.gif"></li><li title="[弱]"><img src="http://localhost:63342/webim/layer/images/face/58.gif"></li><li title="[草泥马]"><img src="http://localhost:63342/webim/layer/images/face/59.gif"></li><li title="[神马]"><img src="http://localhost:63342/webim/layer/images/face/60.gif"></li><li title="[囧]"><img src="http://localhost:63342/webim/layer/images/face/61.gif"></li><li title="[浮云]"><img src="http://localhost:63342/webim/layer/images/face/62.gif"></li><li title="[给力]"><img src="http://localhost:63342/webim/layer/images/face/63.gif"></li><li title="[围观]"><img src="http://localhost:63342/webim/layer/images/face/64.gif"></li><li title="[威武]"><img src="http://localhost:63342/webim/layer/images/face/65.gif"></li><li title="[奥特曼]"><img src="http://localhost:63342/webim/layer/images/face/66.gif"></li><li title="[礼物]"><img src="http://localhost:63342/webim/layer/images/face/67.gif"></li><li title="[钟]"><img src="http://localhost:63342/webim/layer/images/face/68.gif"></li><li title="[话筒]"><img src="http://localhost:63342/webim/layer/images/face/69.gif"></li><li title="[蜡烛]"><img src="http://localhost:63342/webim/layer/images/face/70.gif"></li><li title="[蛋糕]"><img src="http://localhost:63342/webim/layer/images/face/71.gif"></li></ul></div></div></div></div></div>

</div>

<script src="../layer/layui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="../js/jquery.min.js"></script>
<script src="../js/base64.min.js"></script>
<script src="https://underscorejs.net/underscore.js"></script>
<script>

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }

    new Vue(
        {
            el:'#app',
            data:{
                user_id:'',
                current_user_id:'',
                user_avatar:'',
                current_user_avatar:'',
                last_id:'',
                list:[],
                send_content:'',
                host:'http://cw.zhuyan.me',
                send_ids:[]
            },
            created:function () {
                this.user_id = getQueryString('user_id'),
                this.current_user_id = getQueryString('current_user_id'),
                this.user_avatar = getQueryString('user_avatar'),
                this.current_user_avatar = getQueryString('current_user_avatar')


                document.title = Base64.decode(getQueryString('nickname'))

                // console.log(this.user_id),
                // console.log(this.current_user_id),
                // console.log(this.user_avatar),
                // console.log(this.current_user_avatar)
            },
            mounted:function(){
                // alert(3);
                $('.vue-dpn').removeClass('vue-dpn');

                //添加当前时间

                setTimeout(this.newMessage, 3000);
            },
            methods:
                {
                    newMessage()
                    {
                        // console.log(2)
                        var _self = this;
                        var type = this.last_id?1:'';
                        // 阻塞查询
                        $.ajax(
                            {
                                'url':this.host + '/api/chat_message',
                                'type':'post',
                                'data':{
                                    user_id:this.user_id,
                                    current_user_id:this.current_user_id,
                                    user_avatar:this.user_avatar,
                                    current_user_avatar:this.current_user_avatar,
                                    msg_id:this.last_id,
                                    type:type
                                },
                                'async':false,
                                'dataType':'json',
                                success:function(data)
                                {
                                    if( data.status )
                                    {
                                        if( type ) {
                                            for (var i = data.data.data.length; i > 0; i--) {
                                                if( data.data.data[i - 1].send_id && (_self.send_ids.indexOf(data.data.data[i - 1].send_id) !== -1))
                                                {
                                                    continue;
                                                }
                                                _self.pushList(data.data.data[i - 1]);
                                            }
                                        }else
                                        {
                                            _self.last_id = data.data;

                                            //这里去加载历史聊天记录
                                            $.ajax(
                                                {
                                                    'url': _self.host + '/api/chat_message',
                                                    'type': 'post',
                                                    'data': {
                                                        user_id: _self.user_id,
                                                        current_user_id:_self.current_user_id,
                                                        msg_id: _self.last_id,
                                                        type: 2,
                                                        limit:1000
                                                    },
                                                    'async': false,
                                                    'dataType': 'json',
                                                    'success':function(data)
                                                    {
                                                        for (var i = data.data.data.length; i > 0; i--) {
                                                            _self.pushList(data.data.data[i - 1]);
                                                        }

                                                        //把scroll定位到最后
                                                        _self.$nextTick(function(){
                                                            _self.$refs.chatMain.scrollTop = _self.$refs.chatMain.scrollHeight
                                                        })
                                                    }
                                                }
                                            );

                                            // for (var i = 0,j = data.data.data.length; i < j; i++) {
                                            //     _self.pushList(data.data.data[i]);
                                            // }
                                        }
                                    }
                                }
                            }
                        );

                        setTimeout(this.newMessage, 3000);
                    },
                    pushList(msgRecord)
                    {
                        this.list.push(msgRecord);
                        if (this.last_id < msgRecord.id)
                        {
                            this.last_id = msgRecord.id
                        }
                    },
                    sendMsg()
                    {

                        if( !this.send_content )
                        {
                            return;
                        }

                        var content = this.send_content;
                        var send_id = this.current_user_id + '_' +Date.now().toString();
                        this.send_content = '';
                        this.send_ids.push(send_id);
                        this.pushList({id:'','content':content,'user_id':this.current_user_id})

                        /*发送消息*/
                        $.ajax(
                            {
                                url: this.host + '/api/send-chat',
                                data:{
                                    user_id:this.user_id,
                                    current_user_id:this.current_user_id,
                                    content:content,
                                    send_id:send_id
                                },
                                type:'post',
                                dataType:'json',
                                success:function(data)
                                {
                                    if( data.status )
                                    {

                                    }
                                }
                            }
                        )
                    }

                }
        }
    )


</script>
</body>
</html>